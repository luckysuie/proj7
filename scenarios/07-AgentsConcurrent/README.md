# Scenario 07 - Concurrent Agent Orchestration with Semantic Kernel

## Description

This scenario demonstrates concurrent agent orchestration using [Semantic Kernel](https://devblogs.microsoft.com/semantic-kernel/semantic-kernel-multi-agent-orchestration/). The goal is to showcase how multiple agents can work in parallel to analyze user queries and provide valuable insights for future analysis.

Whenever a user performs a search in the store application, two agents are triggered to run concurrently:

- **Sentiment Analysis Agent:** Analyzes the sentiment of the user's query.

- **Language Detection Agent:** Determines the language of the user's query.

While the standard application continues to answer the user's question as usual, the concurrent execution of these agents stores a set of insights (sentiment and language) for each query. These insights are saved for future analysis and can be reviewed in the application.

- [Features](#features)
- [Reference](#reference)
- [Getting Started](#getting-started)
- [Deploying](#deploying)
  - [GitHub CodeSpaces](#github-codespaces)
  - [Run Locally](#run-locally)
  - [Run the solution](#run-the-solution)
  - [.NET Aspire Azure Resources creation](#net-aspire-azure-resources-creation)
  - [Local development using existing models](#local-development-using-existing-models)
  - [Telemetry with .NET Aspire and Azure Application Insights](#telemetry-with-net-aspire-and-azure-application-insights)
- [Architecture Diagram](#architecture-diagram)
- [Guidance](#guidance)
  - [Costs](#costs)
  - [Security Guidelines](#security-guidelines)
- [Additional Resources](#additional-resources)

## Features

- **Concurrent Agent Execution:** Utilizes Semantic Kernel to orchestrate multiple agents running in parallel.
- **Sentiment and Language Analysis:** Each user search is analyzed for sentiment and language.
- **Insights Storage:** Results from the agents are stored for future review.
- **Insights Dashboard:** The store application includes a new page to view the runs and results of user insights generated by the agents.

## Reference

- [Semantic Kernel Multi-Agent Orchestration](https://devblogs.microsoft.com/semantic-kernel/semantic-kernel-multi-agent-orchestration/)

## Getting Started

The solution is in the `./src` folder, the main solution is **[eShopLite-Agents-Concurrent.slnx](./src/eShopLite-Agents-Concurrent.slnx)**.

## Deploying

Once you've opened the project in [Codespaces](#github-codespaces), or [locally](#run-locally), you can deploy it to Azure.

From a Terminal window, open the folder with the clone of this repo and run the following commands.

1. Login to Azure:

    ```shell
    azd auth login
    ```

1. Provision and deploy all the resources:

    ```shell
    azd up
    ```

    It will prompt you to provide an `azd` environment name (like "eShopLite-AgentsConcurrent"), select a subscription from your Azure account, and select a [location where the necessary models gpt-4.1-mini and ADA-002 are available](https://azure.microsoft.com/explore/global-infrastructure/products-by-region/?products=cognitive-services&regions=all) (like "eastus2").

1. When `azd` has finished deploying, you'll see the list of resources created in Azure and a set of URIs in the command output.

1. Visit the **store** URI, and you should see the **eShop Lite app**! üéâ

1. This is an example of the command output:

![Deploy Azure Complete](./images/20AzdUpConsoleComplete.png)

***Note:** The deploy files are located in the `./src/eShopAppHost/infra/` folder. They are generated by the `Aspire AppHost` project.*

### GitHub CodeSpaces

- Create a new Codespace using the `Code` button at the top of the repository.

- The Codespace creation process can take a couple of minutes.

- Once the Codespace is loaded, it should have all the necessary requirements to deploy the solution.

### Run Locally

To run the project locally, you'll need to make sure the following tools are installed:

- [.NET 9](https://dotnet.microsoft.com/downloads/)
- [Git](https://git-scm.com/downloads)
- [Azure Developer CLI (azd)](https://aka.ms/install-azd)
- [Visual Studio Code](https://code.visualstudio.com/Download) or [Visual Studio](https://visualstudio.microsoft.com/downloads/)
  - If using Visual Studio Code, install the [C# Dev Kit](https://marketplace.visualstudio.com/items?itemName=ms-dotnettools.csdevkit)
- .NET Aspire workload:
    Installed with the [Visual Studio installer](https://learn.microsoft.com/dotnet/aspire/fundamentals/setup-tooling?tabs=windows&pivots=visual-studio#install-net-aspire) or the [.NET CLI workload](https://learn.microsoft.com/dotnet/aspire/fundamentals/setup-tooling?tabs=windows&pivots=visual-studio#install-net-aspire).
- An OCI compliant container runtime, such as:
  - [Docker Desktop](https://www.docker.com/products/docker-desktop/) or [Podman](https://podman.io/).

### Run the solution

Follow these steps to run the project, locally or in CodeSpaces:

1. Navigate to the Aspire Host folder project using the command:

   ```bash
   cd ./src/eShopAppHost/
   ```

2. If you are running the project in Codespaces, you need to run this command:

   ```bash
   dotnet dev-certs https --trust
   ```

3. By default the AppHost project creates the necessary resources on Azure. Check the **[.NET Aspire Azure Resources creation](#net-aspire-azure-resources-creation)** section to learn how to configure the project to create Azure resources.

4. Run the project:

   ```bash
   dotnet run
   ```

5. Perform a search in the store application.

6. Visit the new insights page to view the sentiment and language analysis results for each user query.

> **Note:** Working with .NET Aspire in GitHub Codespaces is not fully supported yet. As a developer you need to perform a lot of manual steps to access the .NET Aspire portal, like changing ports to public, copy the access token and more. The .NET Aspire version 9.1 will improve the whole developer experience. We will update these steps when the version 9.1 is released.

## .NET Aspire Azure Resources creation

When utilizing Azure resources in your local development environment, you need to:

- Authenticate to the Azure Tenant where the resources will be created. Run the following command to connect with your Azure tenant:

  ```bash
  az login 
  ```
- Provide the necessary Configuration values are specified under the Azure section in the `eShopAppHost` project:

  - CredentialSource: Delegates to the [AzureCliCredential](https://learn.microsoft.com/dotnet/api/azure.identity.azureclicredential).
  - SubscriptionId: The Azure subscription ID.
  - AllowResourceGroupCreation: A boolean value that indicates whether to create a new resource group.
  - ResourceGroup: The name of the resource group to use.
  - Location: The Azure region to use.

Consider the following example for the *appsettings.json* file in the eShopAppHost project configuration:

```json
{
  "Azure": {
    "CredentialSource": "AzureCli",
    "SubscriptionId": "<Your subscription id>",
    "AllowResourceGroupCreation": true,
    "ResourceGroup": "<Valid resource group name>",
    "Location": "<Valid Azure location>"
  }
}
```

Check [.NET Aspire Azure hosting integrations](https://learn.microsoft.com/dotnet/aspire/azure/local-provisioning#net-aspire-azure-hosting-integrations) for more information on how .NET Aspire create the necessary cloud resources for local development.

### Local development using existing models

In order to use existing models: gpt-4.1-mini and text-embedding-ada-002, you need to define the specific connection string in the `eShopAppHost` project.

Add a user secret with the configuration:

```bash
cd src/eShopAppHost

dotnet user-secrets set "ConnectionStrings:openai" "Endpoint=https://<endpoint>.openai.azure.com/;Key=<key>;"
```

This Azure OpenAI service must contain:

- a `gpt-4.1-mini` model named **gpt-41-mini**
- a `text-embedding-ada-002` model named **text-embedding-ada-002**

### Telemetry with .NET Aspire and Azure Application Insights

The eShopLite solution leverages the Aspire Dashboard and Azure Application Insights to provide comprehensive telemetry and monitoring capabilities

The **.NET Aspire Dashboard** offers a centralized view of the application's performance, health, and usage metrics. It integrates seamlessly with the Azure OpenAI services, allowing developers to monitor the performance of the `gpt-4.1-mini` and `text-embedding-ada-002` models. The dashboard provides real-time insights into the application's behavior, helping to identify and resolve issues quickly.

**Azure Application Insights** complements the Aspire Dashboard by offering deep diagnostic capabilities and advanced analytics. It collects detailed telemetry data, including request rates, response times, and failure rates, enabling developers to understand how the application is performing under different conditions. Application Insights also provides powerful querying and visualization tools, making it easier to analyze trends and detect anomalies.

By combining the Aspire Dashboard with Azure Application Insights, the eShopLite solution ensures robust monitoring and diagnostics, enhancing the overall reliability and performance of the application.

## Architecture Diagram

_WIP - Coming soon!_

## Guidance

### Costs

For **Azure OpenAI Services**, pricing varies per region and usage, so it isn't possible to predict exact costs for your usage.
The majority of the Azure resources used in this infrastructure are on usage-based pricing tiers.
However, Azure Container Registry has a fixed cost per registry per day.

You can try the [Azure pricing calculator](https://azure.com/e/2176802ea14941e4959eae8ad335aeb5) for the resources:

- Azure OpenAI Service: S0 tier, gpt-4.1-mini and text-embedding-ada-002 models. Pricing is based on token count. [Pricing](https://azure.microsoft.com/pricing/details/cognitive-services/openai-service/)
- Azure Container App: Consumption tier with 0.5 CPU, 1GiB memory/storage. Pricing is based on resource allocation, and each month allows for a certain amount of free usage. [Pricing](https://azure.microsoft.com/pricing/details/container-apps/)
- Azure Container Registry: Basic tier. [Pricing](https://azure.microsoft.com/pricing/details/container-registry/)
- Log analytics: Pay-as-you-go tier. Costs based on data ingested. [Pricing](https://azure.microsoft.com/pricing/details/monitor/)
- Azure Application Insights pricing is based on a Pay-As-You-Go model. [Pricing](https://learn.microsoft.com/azure/azure-monitor/logs/cost-logs).

‚ö†Ô∏è To avoid unnecessary costs, remember to take down your app if it's no longer in use, either by deleting the resource group in the Portal or running `azd down`.

### Security Guidelines

Samples in this templates uses Azure OpenAI Services with ApiKey and [Managed Identity](https://learn.microsoft.com/entra/identity/managed-identities-azure-resources/overview) for authenticating to the Azure OpenAI service.

The Main Sample uses Managed Identity](https://learn.microsoft.com/entra/identity/managed-identities-azure-resources/overview) for authenticating to the Azure OpenAI service.

Additionally, we have added a [GitHub Action](https://github.com/microsoft/security-devops-action) that scans the infrastructure-as-code files and generates a report containing any detected issues. To ensure continued best practices in your own repository, we recommend that anyone creating solutions based on our templates ensure that the [Github secret scanning](https://docs.github.com/code-security/secret-scanning/about-secret-scanning) setting is enabled.

You may want to consider additional security measures, such as:

- Protecting the Azure Container Apps instance with a [firewall](https://learn.microsoft.com/azure/container-apps/waf-app-gateway) and/or [Virtual Network](https://learn.microsoft.com/azure/container-apps/networking?tabs=workload-profiles-env%2Cazure-cli).

## Additional Resources

- [Semantic Kernel Documentation](https://aka.ms/semantic-kernel)
- [eShopLite Main Repository](../..)
- [Deploy a .NET Aspire project to Azure Container Apps using the Azure Developer CLI (in-depth guide)](https://learn.microsoft.com/dotnet/aspire/deployment/azure/aca-deployment-azd-in-depth)
- [Aspiring .NET Applications with Azure OpenAI](https://learn.microsoft.com/shows/azure-developers-dotnet-aspire-day-2024/aspiring-dotnet-applications-with-azure-openai)

---

*This scenario is part of the eShopLite sample, demonstrating advanced AI orchestration patterns for .NET developers.*